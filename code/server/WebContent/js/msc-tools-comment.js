(function($,msc){var USER=msc.user,DIALOG=msc.ui.dialog,MSCEVENT=msc.event,ELAPSED=msc.tools.date.elapsed,LOADINGCLASS='loading',cache={},Event,tools,_$,getTemplate;var comment=msc.tools.comment=function(config){return comment.init(config);}
comment.init=function(config){config=comment.config=$.extend(true,{},{run:1,offsetTop:0,element:null,order:[{'key':'desc','text':'最新'},{'key':'asc','text':'最早'}],data:{pageSize:15,page:1,orderBy:'desc',isEdit:0,isDel:1,isReply:1},url:{list:"/meishi2.php?ac=comment&op=clist",add:"/meishi2.php?ac=comment&op=addandcreply",del:"/meishi2.php?ac=comment&op=cdel",reply:"/meishi2.php?ac=comment&op=addandcreply",getInfo:"/meishi2.php?ac=comment&op=cedit",save:"/meishi2.php?ac=comment&op=csave"},str:'还没有人评论，抢占第一条吧~',isAdd:1,isScroll:1,isPage:1,isOrder:0},config||{});if((config.element=$(config.element)).length<1){return comment;}
if(msc.tools.queryUrl("cid")){config.data.cid=msc.tools.queryUrl("cid");}
USER.ready(function(){if(config.isScroll){if(MSCEVENT){MSCEVENT.scroll.add("comment",function(win){if(win.scrollTop+win.height>=config.element.offset().top){comment.run();MSCEVENT.resize.remove("comment");return false;}});MSCEVENT.resize.add("comment",function(){MSCEVENT.scroll.trigger("comment");});setTimeout(function(){MSCEVENT.scroll.trigger("comment");},100);}else{comment.run();}}else{config.run&&comment.run();}});comment.init=noop;}
comment.run=function(){appendHtml();bindEvent();if(comment.config.isOrder){_$("order").find("a[data-type='"+comment.config.data.orderBy+"']").click();}else{getListJson();}
comment.run=noop;}
comment.reload=function(){comment.config.data.page=1;getListJson();return comment;}
function getListJson(){if(!cache.GETING){cache.GETING=1;_$("loading").show();_$("error").hide();$.get(getUrl("list"),function(res){if(res.error===0){renderData(res);}else{_$("error").html('数据加载失败, <a href="javascript:;" onclick="msc.tools.comment.reload();">重试</a>!').show();}
_$("loading").hide();delete cache.GETING;},"json");}}
function renderData(res){var config=comment.config,str;_$("list").empty();if(res.data&&res.data.length){config.recordCount=res.recordCount|0;config.pageCount=Math.ceil(config.recordCount/config.data.pageSize);str=getTemplate("list")({list:res.data||[],renderBefrom:renderBefrom,rep_p:rep_p,elapsed:ELAPSED});if(msc.tools.browser.isIe6){_$("list")[0].innerHTML=str;}else{$(str).hide().appendTo(_$("list")).fadeIn();}
if(config.data.cid&&config.data.cid==res.data[0].cid){_$("lookReply").show().find("a").click(function(){delete config.data.cid;_$("lookReply").hide();comment.reload();return false;});config.pageCount=0;}}else{config.pageCount=config.recordCount=0;_$("error").html(config.str).show();}
setRecordcount();if(config.isPage)
setPage();$(".comment-wrap img").imgLoad();}
function setRecordcount(str){if(str==="-"){--comment.config.recordCount;}else if(str==="+"){++comment.config.recordCount;};_$("recordCount")[0].innerHTML=(comment.config.recordCount|0)+"条";}
function getUrl(type){var config=comment.config,url=config.url[type];if(url.indexOf("?")>-1){url+='&';}else{url+='?';}
return url+$.param(config.data)+"&r="+(+new Date);}
function appendHtml(){var config=comment.config,html='';if(config.isAdd){html+=getTemplate('text')({type:'add',typeValue:'发表评论'});}
html+='<div class="comment-nav mt20" data-dom="nav">'+'<div class="left">最新评论 <strong>（<span data-dom="recordCount">0</span>）</strong></div>';if(config.isOrder){html+='<div class="right" data-dom="order">';$.each(config.order,function(index,value){html+='<a href="#" data-type="'+value.key+'" title="点击切换到 ['+value.text+'] 排序">'+value.text+'</a>'});html+='</div>';}
html+='</div>';html+='<div class="comment-cid mt10" data-dom="lookReply">'+'<a href="#">您正在查看回复评论, 点击查看全部评论</a>'+'</div>';html+='<div class="comment-list mt10">'+'<div class="data-error" data-dom="error"></div>'+'<div class="comment-loading" data-dom="loading">正在请求数据</div>'+'<div data-dom="list"></div>'+'</div>';if(config.isPage){html+='<div class="ui-page mt20" data-dom="page"><div class="ui-page-inner" data-dom="pageInner"></div></div>';}
config.element[0].innerHTML='<div data-dom="wrap" class="comment-wrap">'+html+'</div>';}
Event={edit_cancel:function(){$(this).closest("li").data("status",2).find(".content").show().next().hide();},edit_submit:function(){var $li=$(this).closest("li"),$edit,$content;if($li.data("status")!==4){$edit=$li.find(".comment-edit");$content=$li.find(".content");textVerification($edit.find(".text")[0].value,$edit.find(".text"),function(value,$text){$li.data("status",4);$edit.addClass(LOADINGCLASS);$.post(getUrl("save")+"&cid="+$li.attr("data-id"),{message:value},function(res){$edit.removeClass(LOADINGCLASS);if(res.error===0&&res.data&&res.data.message){$content.html(res.data.message).show();$edit.hide();$li.data("status",2);}else{$li.data("status",3);DIALOG.error(res.msg||"待会再试吧");}},"json");});}},edit:function(){var that=this,$li=$(that).closest("li"),$edit,status=$li.data("status")|0;if(status===0){$li.data("status",1);$li.find(".content").hide();$edit=$(getTemplate("text")({type:'edit',typeValue:'保存',className:LOADINGCLASS})).appendTo($li.find(".detail"));$.get(getUrl("getInfo"),{cid:$li.attr("data-id")},function(res){if(res.error===0&&res.data&&res.data.message){$li.data("status",3);$edit.removeClass(LOADINGCLASS).find(".text").val(res.data.message).focus();}else{DIALOG.error(res.msg||'请求失败');$edit.remove();$li.data("status",0).find(".content").show();}},"json");}else if(status===2){$li.data("status",3).find(".content").hide();$li.find(".comment-edit").show().find(".text").focus();}else if(status===3){$li.data("status",2).find(".content").show();$li.find(".comment-edit").hide();}},del:function(){var that=this,$li;if(that.innerHTML!=='删除中'){$li=$(that).closest("li");DIALOG.alert({content:(($li.data("status")|0)===3?["您正在编辑该评论，确定删除吗？","删除后您当前编辑的内容也将删除"]:"确定删除这条评论吗？"),okValue:"删除",ok:function(){that.innerHTML='删除中';$.get(getUrl("del"),{cid:$li.attr("data-id")},function(res){if(res.error===0){DIALOG.success("删除成功");if(_$("list").find("li").length<2){comment.reload();}else{$li.slideUp(300,function(){$(this).remove();});setRecordcount("-");}}else{DIALOG.error(res.msg||"亲，休息会再试吧");that.innerHTML='删除';}
$li=null;},"json");},cancel:1});}},reply_cancel:function(){$(this).closest("li").data("status",3).find(".comment-reply").hide();},reply:function(){var that=this,$li=$(that).closest("li"),status=$li.data("status")|0;if(status===0){$li.data("status",1);$(getTemplate("text")({type:'reply',typeValue:'回复'})).appendTo($li.find(".detail")).find(".text").focus();}else if(status===1){$li.data("status",3).find(".comment-reply").hide();}else if(status===3){$li.data("status",1).find(".comment-reply").show().find(".text").focus();}},reply_submit:function(){var that=this,$li=$(that).closest("li"),$reply;if($li.data("status")!==2){$reply=$li.find(".comment-reply");textVerification($reply.find(".text")[0].value,$reply.find(".text"),function(value,$text){$reply.addClass(LOADINGCLASS);$li.data("status",2);$.post(getUrl("reply")+"&cid="+$li.attr("data-id"),{message:value},function(res){$reply.removeClass(LOADINGCLASS);if(res.error===0&&res.data&&res.data.message){_$("list").find("ul").prepend(getTemplate("item")({cid:res.data.cid,userName:USER.data.userName,userId:USER.data.userId,avatarPic:USER.data.avatarPic,message:res.data.message,isEdit:comment.config.data.isEdit,isDel:comment.config.data.isDel}));setRecordcount("+");scrollTo("#J_comment_item_"+res.data.cid);$("#J_comment_item_"+res.data.cid).find(".imgLoad").imgLoad();$text.val("");$reply.hide();return $li.data("status",3);}else if(res.error===10001){USER.exit().login();}else if(res.state==="error"){if(e.info!='')
DIALOG.error(e.info);else
DIALOG.error("亲，请修改您的内容");$text.focus();}else{DIALOG.error(res.msg||"亲，休息会再试吧");}
$li.data("status",1);},"json");});}},smilies:function(){var that=this;msc.ui.smilies(that,function(title){tools.add($(that).closest(".comment-post").find(".text")[0],title);});},add_submit:function(){var that=this;if(that!=='发表中'){textVerification(_$("add").find(".text")[0].value,_$("add").find(".text"),function(message,$text){that.innerHTML='发表中';_$("add").addClass(LOADINGCLASS);$.post(getUrl("add"),{message:message},function(e){_$("add").removeClass(LOADINGCLASS);that.innerHTML='发表评论';if(e.error===0&&e.data){if(_$("list").find("li").length<1){getListJson();}else{_$("list").find("ul").eq(0).prepend(getTemplate("item")({cid:e.data.cid,userName:USER.data.userName,userId:USER.data.userId,avatarPic:USER.data.avatarPic,message:e.data.message,isEdit:comment.config.data.isEdit,isDel:comment.config.data.isDel}));scrollTo("#J_comment_item_"+e.data.cid);$("#J_comment_item_"+e.data.cid).find(".imgLoad").imgLoad();setRecordcount("+");}
$text[0].value="";DIALOG.success("评论成功");}else if(e.state==="error"){if(e.info!='')
DIALOG.error(e.info);else
DIALOG.error("亲，请修改您的内容");$text[0].focus();}else{DIALOG.error(e.msg||"亲，休息会再试吧");$text[0].focus();}},"json");});}},login:$.noop}
function bindEvent(){var config=comment.config;if(config.isOrder){_$("order").on("click","a",function(event){if(!cache.GETING){$(this).addClass("on").siblings().removeClass("on");config.data.orderBy=$(this).attr("data-type");config.data.page=1;getListJson();}
event.preventDefault();});}
if(config.isPage){_$("page").on("click","a",function(event){if(!cache.GETING){config.data.page=this.getAttribute("data-page");getListJson();scrollTo(_$("nav").offset().top);}
event.preventDefault();});}
_$("wrap").on("click","a.J_event",function(event){var that=this,type=that.getAttribute("data-type");if(type&&Event[type]){if(type==='smilies'||type.indexOf("cancel")>-1){Event[type].call(that);}else{USER.login(function(){Event[type].call(that);});}}
event.stopPropagation();event.preventDefault();});if(USER.check()){_$("wrap").on("keydown",".text",function(e){if(e.ctrlKey&&e.keyCode===13){$(this).closest(".comment-post").find("a.comment-btn").click();$(this).blur();}});if(msc.tools.browser.isMedia){_$("wrap").on("focus",".text",function(){$(this).closest(".comment-post-text").addClass("comment-post-focus");}).on("blur",".text",function(){$(this).closest(".comment-post-text").removeClass("comment-post-focus");});}
_$("add").addClass("islogin");}
setInterval(function(){_$("list").find("span.subtime").each(function(){this.innerHTML=ELAPSED(this.getAttribute("data-time")*1000);});},6e4);}
function noop(){return comment;}
function renderBefrom(str){str=(str+"").toLowerCase();var url='//www.meishichina.com/Mobile/',befrom={wap:{name:"手机版",url:url+"WAP/"},iphone:{name:"iPhone客户端",url:url+"iPhone/"},ipad:{name:"iPad客户端",url:url+"iPad/"},android:{name:"Android客户端",url:url+"Android/"},symbian:{name:"Symbian客户端",url:url+"Symbian/"},kjava:{name:"Kjava客户端",url:url+"Kjava/"}},key;for(key in befrom){if(str.indexOf(key)>-1){befrom='<div class="comment-befrom">来自: <a href="https://www.meishichina.com/Mobile/" target="_blank">'+befrom[key].name+'</a></div>';break;}}
return"string"===typeof(befrom)?befrom:"";}
function rep_p(str){str=str.replace(/\\\"/g,"\"");return str;}
function scrollTo(top){if("number"!==typeof(top)){top=$(top).offset().top;}
window.scrollTo(0,top+(comment.config.offsetTop|0));}
function setPage(){var str="",conf=comment.config,page=conf.data.page|0,pageSize=conf.pageSize|0,i=1,pageCount=conf.pageCount|0;if(pageCount>1){if(page>1){str+='<a href="#" data-page="'+(page-1)+'">上一页</a>';}
if(pageCount<7){for(i;i<=pageCount;i++){if(page===i){str+='<span class="on">'+i+'</span>';}else{str+='<a href="#"" data-page="'+i+'">'+i+'</a>';}}}else{var start,end;if(page===1){str+='<span class="on">1</span>';}else{str+='<a href="#" data-page="1">1</a>';};if(page>4){str+='<span class="dot">...</span>';};if(page<5){start=1;}else{start=page-2;};if(page>(pageCount-4)){end=pageCount;}else{end=page+3;};for(var i2=start;i2<end;i2++){if(i2!==1&&i2!==pageCount){if(i2===page){str+='<span class="on">'+i2+'</span>';}else{str+='<a href="#" data-page="'+i2+'">'+i2+'</a>';};};};if(page<(pageCount-4)){str+='<span class="dot">...</span>';};if(page===pageCount){str+='<span class="on">'+pageCount+'</span>';}else{str+='<a href="#" data-page="'+pageCount+'">'+pageCount+'</a>';};start=end=null;};if(page<pageCount){str+='<a href="#" data-page="'+(page+1)+'">下一页</a>';};page=pageCount=pageSize=i=null;}
if(str){_$("page").show()[0].children[0].innerHTML=str;str=null;}else{_$("page").hide();}}
_$=function(){var cache={};return function(name){return cache[name]||(cache[name]=comment.config.element.find("[data-dom='"+name+"']"));}}();getTemplate=function(){var cache={_text:'<div class="comment-post comment-<%=type%> <%=className%>" data-dom="<%=type%>">'+'<%if (type==="add"){ %>'+'<div class="comment-login" title="请先登录"></div>'+'<div class="comment-login-text" title="请先登录"><a href="javascript:;" class="J_event" data-type="login">登录</a>后参与讨论，发表评论</div>'+'<% } %>'+'<div class="comment-post-loading"></div>'+'<i class="arrow"></i>'+'<div class="comment-post-text">'+'<div class="comment-post-text-inner">'+'<textarea class="text ui-webkit-scrollbar" title="Ctrl+Enter 也可提交哦"></textarea>'+'</div>'+'</div>'+'<div class="comment-post-tools clear">'+'<div class="left">'+'<a href="#" class="J_event comment-smilies-a" data-type="smilies" title="插入表情"></a>'+'<span class="tips">Ctrl+Enter 也可提交哦</span>'+'</div>'+'<div class="right">'+'<% if(type !== "add"){ %>'+'<a href="#" class="tips J_event" data-type="<%=type%>_cancel">取消</a>'+'<% } %>'+'<a href="#" class="comment-btn J_event" data-type="<%=type%>_submit"><%=typeValue%></a>'+'</div>'+'</div>'+'</div>',_list:'<ul>'+'<%for(var i = 0,len=list.length;i<len;i++){ %>'+'<li id="J_comment_item_<%=list[i].cid%>" data-id="<%=list[i].cid%>">'+'<div class="pic">'+'<a href="https://home.meishichina.com/space-<%=list[i].authorid%>.html" target="_blank" title="点击进入 <%=list[i].author%> 的主页">'+'<img class="imgLoad" src="//static.meishichina.com/v6/img/blank.gif" data-src="<%=list[i].avatarpic%>" width="48" height="48">'+'</a>'+'</div>'+'<div class="detail">'+'<div class="tools">'+'<div class="left">'+'<a title="点击进入 <%=list[i].author%> 的主页" href="https://home.meishichina.com/space-<%=list[i].authorid%>.html" target="_blank"><%=list[i].author%></a><span class="subtime" data-time="<%=list[i].dateline%>"><%=elapsed(list[i].dateline * 1000)%></span>'+'</div>'+'<div class="right">'+'<%if(list[i].isEdit){ %>'+'<a href="#" class="J_event" data-type="edit">编辑</a>'+'<% } %>'+'<%if(list[i].isDel){ %>'+'<a href="#" class="J_event" data-type="del">删除</a>'+'<% } %>'+'<%if(list[i].isReply){ %>'+'<a href="#" class="J_event" data-type="reply">回复</a>'+'<% } %>'+'</div>'+'</div>'+'<div class="content"><%==rep_p(list[i].message)%>'+'<% if(list[i].pic){ %>'+'<img src="<%=list[i].pic%>" class="imgLoad"/>'+'<% } %>'+'</div>'+'<% if(list[i].befrom){ %>'+'<%==renderBefrom(list[i].befrom)%>'+'<% } %>'+'</div>'+'</li>'+'<% } %>'+'</ul>',_item:'<li id="J_comment_item_<%=cid%>" data-id="<%=cid%>">'+'<div class="pic">'+'<a href="#">'+'<img class="imgLoad" src="//static.meishichina.com/v6/img/blank.gif" data-src="<%=avatarPic%>" width="48" height="48">'+'</a>'+'</div>'+'<div class="detail">'+'<div class="tools">'+'<div class="left">'+'<a title="点击进入 <%=userName%> 的主页" href="https://home.meishichina.com/space-<%=userId%>.html" target="_blank"><%=userName%></a><span>刚刚</span>'+'</div>'+'<div class="right">'+'<%if(isEdit){ %>'+'<a href="#" class="J_event" data-type="edit">编辑</a>'+'<% } %>'+'<%if(isDel){ %>'+'<a href="#" class="J_event" data-type="del">删除</a>'+'<% } %>'+'</div>'+'</div>'+'<div class="content"><%==message%></div>'+'</div>'+'</li>'}
return function(type){if(cache[type]){return cache[type];}else{cache[type]=msc.template.compile(cache["_"+type]);delete cache["_"+type];return cache[type];}}}();function textVerification(value,$text,fn){if(!value||(value=$.trim(value))===""){DIALOG.error("请填写内容!");$text.focus();}else if(value.length<2){DIALOG.error("再填写点内容吧!")
$text.focus();}else{fn(value,$text);}}
tools={getCursorPosition:function(ele){if(document.selection){ele.focus();var ds=document.selection;var range=ds.createRange();var stored_range=range.duplicate();stored_range.moveToElementText(ele);stored_range.setEndPoint("EndToEnd",range);ele.selectionStart=stored_range.text.length-range.text.length;ele.selectionEnd=ele.selectionStart+range.text.length;return ele.selectionStart;}else{return ele.selectionStart;}},setCursorPosition:function(ele,p){this.sel(ele,p,p);},add:function(ele,txt){var val=ele.value;if(document.selection){ele.focus()
document.selection.createRange().text=txt;}else{var cp=ele.selectionStart;var ubbLength=ele.value.length;var s=ele.scrollTop;ele.value=ele.value.slice(0,ele.selectionStart)+txt+ele.value.slice(ele.selectionStart,ubbLength);this.setCursorPosition(ele,cp+txt.length);msc.tools.browser.mozilla&&setTimeout(function(){if(ele.scrollTop!=s)ele.scrollTop=s;},0);};},del:function(ele,n){var p=this.getCursorPosition(ele);var s=ele.scrollTop;var val=ele.value;ele.value=n>0?val.slice(0,p-n)+val.slice(p):val.slice(0,p)+val.slice(p-n);this.setCursorPosition(ele,p-(n<0?0:n));msc.browser.mozilla&&setTimeout(function(){if(ele.scrollTop!=s)ele.scrollTop=s;},10);},sel:function(ele,start,end){if(document.selection){var range=ele.createTextRange();range.moveEnd('character',-ele.value.length);range.moveEnd('character',end);range.moveStart('character',start);range.select();}else{ele.setSelectionRange(start,end);ele.focus();}},selString:function(ele,str){var index=ele.value.indexOf(str);index!=-1?this.sel(ele,index,index+str.length):false;}};}(jQuery,msc));